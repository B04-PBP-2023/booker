{% extends 'base.html' %}
{% load static %}

{% block meta %}
<link href="{% static 'style.css' %}" rel="stylesheet">
{% endblock meta %}

{% block content %}

<style>
  div .container {
    margin-top: 1em;
  }

  h1 {
    margin-top: 5em;
  }

  canvas {
    margin-top: 3em;
  }
</style>


<div class="container h-100">
  <h1>Data Stok Buku</h1>
</div>
<div class="container h-100">
  <div class="d-flex justify-content-center h-100">
    <div class="searchbar field w-75 w-lg-50">
      <input id="search_input" class="search_input" type="text" name="" placeholder="Cari buku, penulis, genre...">
      <span><button id="search_button" class="fas fa-search" onclick=""></button></span>
    </div>
  </div>
</div>
<div class="container h-100">
  <div class="d-flex justify-content-center align-items-center">
    <table class="table table-sm table-striped table-bordered" id="stock_table">
    </table>
  </div>
</div>
<div class="container h-100">
  <h1>Data Statistik Stok Peminjaman Buku</h1>
</div>
<div class="container h-100">
  <div class="d-flex justify-content-center align-items-center">
    <canvas id="labelChartAuthor"></canvas>
  </div>
</div>
<div class="container h-100">
  <div class="d-flex justify-content-center align-items-center">
    <canvas id="labelChartYear"></canvas>
  </div>
</div>
<div class="container h-100">
  <div class="d-flex justify-content-center align-items-center">
    <canvas id="labelChartGenre"></canvas>
  </div>
</div>
<script>

  search_button = document.getElementById("search_button");
  search_button.addEventListener("click", async () => {
    query = document.getElementById("search_input").value;
    await searchBooks(query)
  })

  input = document.getElementById("search_input");
  input.addEventListener("keypress", (event) => {
    if (event.key === "Enter") {
      event.preventDefault();
      document.getElementById("search_button").click();
    }
  });

  async function searchBooks(q) {
    books = await fetch(`{% url 'book:search_books'%}` + `?q=${q}`).then((res) => res.json());
    await refreshTable(books);
  }

  async function getBooks() {
    booksTable = await fetch("{% url 'book:get_books' %}").then((res) => res.json());
    await refreshTable(booksTable);
    booksCharts = await fetch("{% url 'bookshelf:get_bookshelf_items' %}" + `?borrow=${1}`).then((res) => res.json());
    await refreshCharts(booksCharts);
    }

  getBooks()
 
  async function refreshTable(books) {
    let htmlString = `<tr class="table-dark">
            <th>No.</th>
            <th>Name</th>
            <th>Author</th>
            <th>Year</th>
            <th>Genre</th>
            <th>Stock</th>
        </tr>`
    var a = 1;
    books.forEach((book) => {
      htmlString += `\n<tr>
            <td>${a}</td>
            <td>${book.fields.name}</td>
            <td>${book.fields.author}</td>
            <td>${book.fields.year}</td>
            <td>${book.fields.genre}</td>
            <td>${book.fields.stock}</td>
        </tr>`; a += 1
    })

    document.getElementById("stock_table").innerHTML = htmlString
  }
 

  async function refreshCharts(books) {

    const xValuesAuthor = []; const yValuesStockAuthor = []; var authorColors = [];
    var xValuesYear = []; var yValuesStockYear = []; var yearColors = [];
    var xValuesGenre = ["Non Fiction", "Fiction"]; var yValuesStockGenre = [0, 0]; var genreColors = ["Red", "Blue"];

    books.forEach((book) => {
      const randomColorMath1 = Math.floor(Math.random() * 16777215).toString(16);
      const randomColor1 = "#" + randomColorMath1
      const randomColorMath2 = Math.floor(Math.random() * 16777215).toString(16);
      const randomColor2 = "#" + randomColorMath2
      var authorIndex = xValuesAuthor.findIndex(author => author === book.book.author);
      var yearIndex = xValuesYear.findIndex(year => year === book.book.year);

      if (authorIndex === -1) {
        xValuesAuthor.push(book.book.author);
        yValuesStockAuthor.push(1);
        authorColors.push(randomColor1);
      } else if (authorIndex !== -1) {
        yValuesStockAuthor[authorIndex] += 1;
      } if (yearIndex === -1) {
        xValuesYear.push(book.book.year);
        yValuesStockYear.push(1);
        yearColors.push(randomColor2);
      } else if (yearIndex !== -1) {
        yValuesStockYear[yearIndex] += 1;
      } if (book.book.genre == "Non Fiction") {
        yValuesStockGenre[0] += 1;
      } else if (book.book.genre == "Fiction") {
        yValuesStockGenre[1] += 1;
      }
    });

    new Chart("labelChartAuthor", {
      type: "pie",
      data: {
        labels: xValuesAuthor,
        datasets: [{
          backgroundColor: authorColors,
          data: yValuesStockAuthor
        }]
      },
      options: {
        title: {
          display: true,
          text: "Berdasarkan Author"
        },
        maintainAspectRatio: false,
        responsive: true
      }
    });
    new Chart("labelChartYear", {
      type: "pie",
      data: {
        labels: xValuesYear,
        datasets: [{
          backgroundColor: yearColors,
          data: yValuesStockYear
        }]
      },
      options: {
        title: {
          display: true,
          text: "Berdasarkan Tahun"
        },
        maintainAspectRatio: false,
        responsive: true
      }
    });
    new Chart("labelChartGenre", {
      type: "pie",
      data: {
        labels: xValuesGenre,
        datasets: [{
          backgroundColor: genreColors,
          data: yValuesStockGenre
        }]
      },
      options: {
        title: {
          display: true,
          text: "Berdasarkan Genre"
        },
        maintainAspectRatio: false,
        responsive: true
      }
    });
  }
</script>
{% endblock content %}